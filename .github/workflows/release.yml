name: create release
run-name: "Release ${{ inputs.releaseversion }}"

env:
    IMAGE_NAME_DB: "msamt-online/db"
    REGISTRY: "ghcr.io/bungeberatung"

on:
    workflow_dispatch:
        inputs:
            releaseversion:
                description: 'Release version (yyyy.mm.<no>)'
                required: true
                type: string
                default: "X.Y.Z"

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: write
            attestations: write
            id-token: write

        steps:
            -   name: Check out
                uses: actions/checkout@v3
                with:
                    fetch-depth: 0

            -   name: Set up JDK 11
                uses: actions/setup-java@v3
                with:
                    distribution: 'adopt'
                    java-version: 11

            -   name: Setup settings.xml
                uses: s4u/maven-settings-action@v3.1.0
                with:
                    override: true
                    servers: |
                        [{
                            "id": "repo.jenkins-ci.org",
                            "username": "${{ secrets.OSS_JENKINS_USER }}",
                            "password": "${{ secrets.OSS_JENKINS_PASS }}"
                        }]


            -   name: Create Pull Request
                id: create-pr
                uses: peter-evans/create-pull-request@v7
                with:
                    commit-message: Update report
                    committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
                    author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
                    branch: release/${{ inputs.releaseversion }}
                    delete-branch: true
                    title: '[Release] ${{ inputs.releaseversion }}'
                    body: |
                        Release Plugin v${{ inputs.releaseversion }}
                    labels: |
                        release
                    assignees: hypery2k
                    draft: false

            -   name: 'Set Up Node.js'
                uses: actions/setup-node@v4
                with:
                    node-version: '20'

            -   name: Create release
                env:
                    GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
                run: |
                    export TZ="Europe/Berlin"
                    mvn release:prepare release:perform -B -DreleaseVersion=${{ inputs.releaseversion }} -DskipITs=true  -DlocalCheckout=true -D"arguments=-DskipITs=true"
                    # write version info
                    cat <<EOF >target/config.json
                    {
                      "version": "${{ inputs.releaseversion }}"
                    }
                    EOF


            -   name: Conventional Changelog Action
                uses: TriPSs/conventional-changelog-action@v5
                with:
                    input-file: CHANGELOG.md
                    github-token: ${{ secrets.GITHUB_TOKEN }}
                    version-file: target/config.json
                    pre-release: true
                    skip-bump: true
                    skip-tag: true
                    skip-on-empty: true
                    tag-prefix: 'v'
